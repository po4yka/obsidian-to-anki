# Cursor AI Rules for obsidian-interview-qa-to-anki

## Code Style and Standards

### No Emojis
- NEVER use emojis in code, comments, documentation, or commit messages
- Use plain text for status indicators (e.g., "Complete", "Pending", "Warning")
- Use markdown formatting for emphasis instead of decorative symbols

### Python Style
- Follow PEP 8 style guide
- Line length: 88 characters (Black default)
- Use type hints for all public APIs
- Use Google-style docstrings for all modules, classes, and functions

### Naming Conventions
- `snake_case` for functions and variables
- `PascalCase` for classes
- `UPPER_CASE` for constants
- Descriptive names over abbreviations

### Type Hints
- Required for all function signatures
- Use modern Python 3.13+ syntax (e.g., `list[str]` instead of `List[str]`)
- Use `Optional[T]` for nullable types
- Use `tuple[T1, T2]` for tuples with specific types

### Error Handling
- Use specific exception types, not bare `except Exception`
- Always provide context in error messages
- Log exceptions with `logger.exception()` for full traceback

### Code Organization
- Keep functions under 50 lines when possible
- One class per file (with related helper functions)
- Group imports: stdlib, third-party, local
- Use named constants instead of magic numbers

## Documentation

### Docstrings
```python
def function_name(param1: Type1, param2: Type2) -> ReturnType:
    """
    Brief description of function.

    Longer description if needed, explaining the purpose,
    behavior, and any important details.

    Args:
        param1: Description of param1
        param2: Description of param2

    Returns:
        Description of return value

    Raises:
        ExceptionType: When this exception occurs

    Example:
        >>> function_name(value1, value2)
        expected_result
    """
```

### Comments
- Use comments to explain "why", not "what"
- Keep comments up-to-date with code changes
- No commented-out code in commits

### Markdown Documentation
- Use clear section headers
- Include code examples with proper syntax highlighting
- Keep line length reasonable (80-100 chars)
- Use tables for structured data
- No emojis or decorative symbols

## Testing

### Test Structure
- One test file per module (`test_module.py`)
- Use descriptive test names: `test_feature_with_valid_input`
- Group related tests in classes
- Use fixtures from `conftest.py`

### Test Coverage
- Minimum 90% coverage for new code
- 100% coverage for critical paths
- Test both success and failure cases
- Test edge cases and boundary conditions

### Test Documentation
- Each test should have a docstring explaining what it tests
- Use descriptive assertion messages
- Keep tests focused (one concept per test)

## Git Workflow

### Commit Messages
Format: `<type>(<scope>): <subject>`

Types:
- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Code style changes (formatting)
- `refactor`: Code refactoring
- `test`: Adding or updating tests
- `chore`: Maintenance tasks

Example: `feat(parser): add multi-line question support`

### Branch Naming
- `feature/description` for new features
- `fix/issue-number-description` for bug fixes
- `docs/description` for documentation
- `refactor/description` for refactoring

## Project-Specific Rules

### APF Compliance
- All generated cards must follow APF v2.1 specifications
- Validate against `.docs/APF Cards/` documentation
- Run APF linter on all generated content
- Use strict tag taxonomy from Doc B

### Obsidian Integration
- Parse YAML frontmatter with proper error handling
- Support multi-pair Q/A blocks
- Validate file paths and resolve to absolute paths
- Handle bilingual content (EN/RU)

### Anki Integration
- Use AnkiConnect API v6
- Implement retry logic for network operations (3 attempts)
- Use connection pooling for HTTP client
- Validate responses before processing

### Synchronization
- Generate stable slugs with collision resolution
- Track content hashes for incremental sync
- Support bidirectional sync (Obsidian â†” Anki)
- Implement dry-run mode for all operations
- Ensure idempotency

### Database
- Use SQLite with WAL mode for concurrency
- Parameterized queries only (no SQL injection)
- Index frequently queried columns
- Clean up old records periodically

### Logging
- Use structured logging with `structlog`
- Log levels: DEBUG for development, INFO for operations, ERROR for failures
- Include context in log messages (file, slug, operation)
- Never log sensitive data (API keys, passwords)

### Configuration
- Use environment variables for secrets
- Provide `.env.example` template
- Validate configuration on startup
- Use sensible defaults

## Dependencies

### Package Management
- Use `uv` for dependency management
- Lock all dependencies in `uv.lock`
- Update dependencies regularly
- Document version requirements

### Adding Dependencies
- Check if functionality exists in stdlib first
- Prefer well-maintained packages
- Update `pyproject.toml` and regenerate lock file
- Document why the dependency is needed

## Performance

### Optimization Guidelines
- Profile before optimizing
- Use batch operations for database and API calls
- Cache expensive computations
- Use generators for large datasets
- Implement connection pooling for HTTP clients

### Memory Management
- Close file handles and database connections
- Use context managers (`with` statements)
- Avoid loading entire files into memory
- Stream large data when possible

## Security

### Best Practices
- Never hardcode secrets
- Validate and sanitize all user input
- Use parameterized SQL queries
- Validate file paths (prevent path traversal)
- Use HTTPS for all external API calls
- Verify SSL certificates

### API Keys
- Store in environment variables
- Never commit to version control
- Rotate keys regularly
- Use minimal required permissions

## Code Review Checklist

Before submitting PR:
- [ ] All tests pass (`pytest`)
- [ ] Linting passes (`ruff check src/`)
- [ ] Formatting applied (`black src/`)
- [ ] Type checking passes (`mypy src/`)
- [ ] Documentation updated
- [ ] No emojis in code or documentation
- [ ] Commit messages follow convention
- [ ] Code coverage maintained or improved

## Tools Configuration

### Black
- Line length: 88
- Target version: Python 3.13

### Ruff
- Line length: 88
- Target version: Python 3.13
- Enable all recommended rules

### Mypy
- Python version: 3.13
- Strict mode enabled
- Warn on unused configs
- Disallow untyped definitions

## References

- Project Requirements: `.docs/REQUIREMENTS.md`
- APF Specifications: `.docs/APF Cards/`
- Testing Guide: `TESTING.md`
- Dependencies: `DEPENDENCIES.md`
- Project Status: `PROJECT_STATUS.md`
