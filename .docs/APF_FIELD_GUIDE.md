# APF Field Guide

Версия: 0.1 (2025-10-12)  
Статус: Draft

Документ описывает поведение конвертера при заполнении полей Anki note types из семейства APF. Используется вместе с `.docs/APF Cards` и `.docs/CARDS_PROMPT.md`.

## 1. Общие принципы

- Каждая карточка имеет набор полей, предписанных note type. Порядок и имена полей не изменяются.
- Все поля содержат HTML; Markdown преобразуется заранее.
- Поле `Additional` сохраняет вспомогательный контент (Follow-ups, References, Related Questions, вводные секции). Если таких данных нет, поле остаётся пустым.
- В конце карточки всегда добавляется `<!-- manifest: {...} -->` согласно требованиям раздела 8 основной спецификации.
- Если note type требует поле, а данных нет, поле заполняется `&nbsp;` (неразрывный пробел), чтобы избежать ошибок импорта.

## 2. Таблица сопоставлений

| Note Type | Поле | Источник данных | Правила заполнения |
|-----------|------|-----------------|--------------------|
| APF::Simple | Front (EN/RU) | `Question (lang)` | Цитата `> ...` или чистый текст. |
| APF::Simple | Back (EN/RU) | `Answer (lang)` | Содержимое секции ответа. |
| APF::Simple | Additional | Follow-ups, References, Related, вводный текст | Секции объединяются, разделяются `<hr>`; пустые поля пропускаются. |
| APF::Missing | Front | `Question (lang)` | Текст вопроса; клоузы размещаются в ClozeX. |
| APF::Missing | Cloze1..N | `Answer (lang)` | Каждый `{{cN::...}}` выделяется отдельным полем. Если клоузов больше, чем предусмотрено шаблоном, карточка отклоняется и логируется. |
| APF::Missing | Back | Полный ответ | Используется версия без клоузов (подстановка фактических ответов). |
| APF::Missing | Additional | Follow-ups, References, Related | Как в Simple. |
| APF::Draw | Front | `Question (lang)` | Инструкции для рисунка. |
| APF::Draw | Drawing | Контент `![draw](...)` или встроенный SVG | При отсутствии графического контента карточка отклоняется. |
| APF::Draw | Back | `Answer (lang)` | Объяснение решения; если нет — `&nbsp;`. |
| APF::Draw | Additional | Follow-ups, References, Related | Как в Simple. |

> Примечание: Для двуязычных заметок каждая карточка (EN и RU) обрабатывается отдельно, но правила сопоставления идентичны.

## 3. Дополнительные замечания

- **Cloze**: нумерация `Cloze1`, `Cloze2` и т.д. должна соответствовать порядку появления `{{cN::` в тексте. Если автор использовал `{{cloze::...}}` без числа, движок выполняет автонумерацию.
- **Drawing**: допустимы файлы SVG/PNG (данные вставляются как Base64) или ссылки на внешние изображения, если это разрешено политикой импорта.
- **Поле Additional**: 
  - Follow-ups перечисляются маркированным списком.
  - References оформляются списком ссылок.
  - Related Questions включают ссылки вида `[[q-...]]`.
- **Пустые поля**: для полей, которые Anki помечает как обязательные (например, `Drawing`), если контент отсутствует и карта всё ещё формируется, записывается `&nbsp;`, а в лог добавляется предупреждение.
- **Расширение**: при появлении новых note type документ расширяется новым разделом с аналогичной таблицей.
